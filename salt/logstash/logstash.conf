input {
  journald {
    lowercase => true
    seekto => "head"
    thisboot => true
    type => "systemd"
    path => "/var/run/log/journal"
  }
}

filter {
  if [syslog_identifier] in ["portal-de-servicos", "editor-de-servicos"] {
    grok {
      match => {
        message => "%{UUID:ticket} %{LOGLEVEL:spring_level}\s+\[%{GREEDYDATA:thread}\] %{JAVACLASS:class} - %{GREEDYDATA:message}"
      }
      overwrite => ["message"]
    }

    grok {
      match => {
        message => "Request: %{WORD:http_method} %{GREEDYDATA:http_uri} - %{IP:http_dst_ip} %{IP:http_src_ip} %{GREEDYDATA:http_agent}"
      }
      add_tag => ["request"]
    }

    grok {
      match => {
        "message" => "Response: HTTP %{NUMBER:http_status} %{GREEDYDATA:http_status_reason} - %{NUMBER:http_elapsed}ms"
      }
      add_tag => ["response"]
    }

    multiline {
      pattern => "(^[a-zA-Z.]+(?:Error|Exception): .+)|(^\s*at .+)|(^\s*... \d+ more)|(^\s*Caused by:.+)"
      what => "previous"
    }

    geoip {
      source => "http_src_ip"
    }

    elapsed {
      start_tag => "request"
      end_tag => "response"
      unique_id_field => "ticket"
    }
  }
}

output {
  elasticsearch {
    cluster => "elasticsearch"
    host => [{% for addr in salt['mine.get']('es*', 'network.ip_addrs').values() %}"{{ addr[0] }}:9300"{% if not loop.last %}, {% endif %}{% endfor %}]
    bind_port => "9301"
    bind_host => "{{ grains['ip4_interfaces']['enp0s8'][0] }}"
    node_name => "logstash-{{ grains['nodename'] }}"
  }
}
